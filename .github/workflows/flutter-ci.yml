name: Flutter CI

on:
  workflow_dispatch:
    inputs:
      channel:
        type: choice
        description: "Channel"
        required: true
        default: "development"
        options:
          - "development"
          - "preview"
          - "production"
      build_logger_level:
        type: choice
        description: "Build Logger Level"
        required: true
        default: "warn"
        options:
          - "trace"
          - "debug"
          - "info"
          - "warn"
          - "error"
          - "fatal"
          - "silent"
      upload_artifact:
        type: boolean
        description: "Upload Artifact"
        required: true
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.channel }}
  cancel-in-progress: true

jobs:
  analyze-and-test:
    name: Analyze and Test
    runs-on: ubuntu-latest
    if: ${{ github.repository == 'Vietnam-Startup-Alliance-VSA/vsa-workplace-project' && github.event_name != 'pull_request' }}
    defaults:
      run:
        working-directory: apps/flutter

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          repository: ${{ secrets.CHECKOUT_REPOSITORY }}
          ref: ${{ github.event.inputs.channel == 'development' && 'develop' || github.event.inputs.channel == 'preview' && 'staging' || github.event.inputs.channel == 'production' && 'main' }}
          ssh-key: ${{ secrets.CHECKOUT_SSH_KEY }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Generate localization
        run: flutter gen-l10n

      - name: Run build_runner
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Check formatting
        run: dart format --set-exit-if-changed .

      - name: Analyze code
        run: flutter analyze

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/flutter/coverage/lcov.info
          flags: flutter
          name: flutter-coverage
        continue-on-error: true

  build-android:
    name: Build Android (${{ matrix.flavor }})
    runs-on: ubuntu-latest
    if: ${{ github.repository == 'Vietnam-Startup-Alliance-VSA/vsa-workplace-project' && github.event_name != 'pull_request' }}
    needs: analyze-and-test
    strategy:
      matrix:
        flavor: [development, staging, production]
    defaults:
      run:
        working-directory: apps/flutter

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          repository: ${{ secrets.CHECKOUT_REPOSITORY }}
          ref: ${{ github.event.inputs.channel == 'development' && 'develop' || github.event.inputs.channel == 'preview' && 'staging' || github.event.inputs.channel == 'production' && 'main' }}
          ssh-key: ${{ secrets.CHECKOUT_SSH_KEY }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Generate localization
        run: flutter gen-l10n

      - name: Run build_runner
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build APK
        run: |
          TARGET="lib/main.dart"
          if [ "${{ matrix.flavor }}" = "staging" ]; then
            TARGET="lib/main_staging.dart"
          elif [ "${{ matrix.flavor }}" = "production" ]; then
            TARGET="lib/main_production.dart"
          fi
          flutter build apk --flavor ${{ matrix.flavor }} --target $TARGET

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.flavor }}
          path: apps/flutter/build/app/outputs/flutter-apk/app-${{ matrix.flavor }}-release.apk
          retention-days: 30

  build-ios:
    name: Build iOS (${{ matrix.flavor }})
    runs-on: macos-latest
    if: ${{ github.repository == 'Vietnam-Startup-Alliance-VSA/vsa-workplace-project' && github.event_name != 'pull_request' }}
    needs: analyze-and-test
    strategy:
      matrix:
        flavor: [development, staging, production]
    defaults:
      run:
        working-directory: apps/flutter

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          repository: ${{ secrets.CHECKOUT_REPOSITORY }}
          ref: ${{ github.event.inputs.channel == 'development' && 'develop' || github.event.inputs.channel == 'preview' && 'staging' || github.event.inputs.channel == 'production' && 'main' }}
          ssh-key: ${{ secrets.CHECKOUT_SSH_KEY }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Generate localization
        run: flutter gen-l10n

      - name: Run build_runner
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build iOS (no codesign)
        run: |
          TARGET="lib/main.dart"
          if [ "${{ matrix.flavor }}" = "staging" ]; then
            TARGET="lib/main_staging.dart"
          elif [ "${{ matrix.flavor }}" = "production" ]; then
            TARGET="lib/main_production.dart"
          fi
          flutter build ios --flavor ${{ matrix.flavor }} --target $TARGET --no-codesign

      - name: Create IPA artifact directory
        run: |
          mkdir -p build/ios/ipa
          cp -r build/ios/iphoneos/Runner.app build/ios/ipa/

      - name: Upload iOS build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.flavor }}
          path: apps/flutter/build/ios/ipa/
          retention-days: 30

  deploy-staging:
    name: Deploy Staging APK
    runs-on: ubuntu-latest
    needs: build-android
    if: ${{ (github.event.inputs.channel == 'development' || github.event.inputs.channel == 'preview') && github.repository == 'Vietnam-Startup-Alliance-VSA/vsa-workplace-project' && github.event_name != 'pull_request' }}

    steps:
      - name: Download staging APK
        uses: actions/download-artifact@v4
        with:
          name: apk-staging
          path: ./

      - name: Get commit info
        id: commit
        run: |
          echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          echo "size=$(du -h app-staging-release.apk | cut -f1)" >> $GITHUB_OUTPUT

      - name: Display build metadata
        run: |
          echo "### ðŸ“± Staging Build Ready"
          echo "**Commit:** ${{ steps.commit.outputs.sha_short }}"
          echo "**Size:** ${{ steps.commit.outputs.size }}"
          echo "**Branch:** ${{ github.ref_name }}"
          echo ""
          echo "APK is available as artifact: apk-staging"

      # Optional: Deploy to Firebase App Distribution if configured
      # - name: Deploy to Firebase
      #   uses: wzieba/Firebase-Distribution-Github-Action@v1
      #   if: secrets.FIREBASE_APP_ID != ''
      #   with:
      #     appId: ${{ secrets.FIREBASE_APP_ID }}
      #     serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      #     groups: testers
      #     file: app-staging-release.apk

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [analyze-and-test, build-android, build-ios]
    if: ${{ failure() && github.repository == 'Vietnam-Startup-Alliance-VSA/vsa-workplace-project' && github.event_name != 'pull_request' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          repository: ${{ secrets.CHECKOUT_REPOSITORY }}
          ref: ${{ github.event.inputs.channel == 'development' && 'develop' || github.event.inputs.channel == 'preview' && 'staging' || github.event.inputs.channel == 'production' && 'main' }}
          ssh-key: ${{ secrets.CHECKOUT_SSH_KEY }}

      - name: Call Lark notification
        uses: ./.github/workflows/lark-notify.yml
        with:
          status: 'failure'
          workflow_name: 'Flutter CI'
        continue-on-error: true
